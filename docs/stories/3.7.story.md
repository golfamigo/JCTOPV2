# Story 3.7: Platform Admin Dashboard

## Status
done

## Story
**As a** platform admin,
**I want** to manage the platform using updated admin interfaces,
**so that** I can maintain platform operations efficiently.

## Acceptance Criteria
1. Admin navigation uses React Native Elements Drawer with sections
2. User management list uses React Native Elements table components
3. Platform statistics use React Native Elements dashboard cards
4. System health indicators use React Native Elements status badges
5. Action confirmations use React Native Elements Dialog components
6. All admin interfaces are fully localized to Traditional Chinese

## Tasks / Subtasks
- [x] Task 1: Create Platform Admin Layout and Navigation (AC: 1, 6)
  - [x] Create `/app/admin/_layout.tsx` with drawer navigation structure
  - [x] Implement React Native Elements Drawer component with sections
  - [x] Add navigation items for Users, Events, System Health, Reports
  - [x] Implement role-based access control to restrict admin routes
  - [x] Add localization keys for all admin navigation items
  - [x] Create tests for layout and navigation

- [x] Task 2: Implement User Management Screen (AC: 2, 6)
  - [x] Create `/app/admin/users.tsx` for user listing
  - [x] Create `UserManagementTable.tsx` component using ListItem
  - [x] Implement user search and filter functionality
  - [x] Add user status badges (active, suspended, deleted)
  - [x] Implement pagination for user list
  - [x] Add actions: view details, suspend/activate, delete
  - [x] Create comprehensive tests for user management

- [x] Task 3: Build Platform Statistics Dashboard (AC: 3, 6)
  - [x] Create `/app/admin/dashboard.tsx` with statistics overview
  - [x] Create `PlatformStatsCard.tsx` using React Native Elements Card
  - [x] Display metrics: total users, active events, revenue, registrations
  - [x] Add time range selector (today, week, month, year)
  - [x] Implement charts using react-native-svg-charts wrapped in RNE containers
  - [x] Add refresh functionality with pull-to-refresh
  - [x] Create tests for statistics display

- [x] Task 4: Develop System Health Monitoring (AC: 4, 6)
  - [x] Create `/app/admin/system-health.tsx` screen
  - [x] Create `SystemHealthIndicator.tsx` using Badge components
  - [x] Display API status, database connection, server resources
  - [x] Implement real-time status updates using polling
  - [x] Add color-coded badges (green=healthy, yellow=warning, red=critical)
  - [x] Include last check timestamp and refresh button
  - [x] Create tests for health monitoring

- [x] Task 5: Implement Action Confirmation Dialogs (AC: 5, 6)
  - [x] Create `ConfirmationDialog.tsx` using React Native Elements Dialog
  - [x] Implement for user suspension/deletion actions
  - [x] Implement for event unpublishing/deletion actions
  - [x] Add loading states during action processing
  - [x] Include success/error toast notifications
  - [x] Ensure all confirmation messages are in Traditional Chinese
  - [x] Create tests for dialog interactions

- [x] Task 6: Create Admin Service Layer
  - [x] Create `adminService.ts` for admin API calls
  - [x] Implement `getPlatformStatistics()` method
  - [x] Implement `getAllUsers()` with pagination
  - [x] Implement `updateUserStatus()` method
  - [x] Implement `getSystemHealth()` method
  - [x] Implement `getEventAuditLog()` method
  - [x] Add proper error handling and retry logic
  - [x] Create unit tests for all service methods

- [x] Task 7: Add Role-Based Access Control
  - [x] Update `authService.ts` to include user role checking
  - [x] Create `useAdminAuth()` hook for admin-only routes
  - [x] Implement redirect to main app for non-admin users
  - [x] Add role field to User interface in shared-types
  - [x] Create middleware to protect admin routes
  - [x] Add tests for access control

## Dev Notes

### Previous Story Insights
[Source: Story 3.6 - My Tickets Screen]
- Successfully implemented React Native Elements components with Traditional Chinese localization
- Used atomic design pattern for component organization
- Implemented proper test coverage with `.spec.tsx` files
- Applied platform-specific optimizations (haptics for iOS, ripple for Android)
- Extracted constants for better maintainability (status colors, date formats)
- Used useCallback hooks for performance optimization

### Component Architecture
[Source: docs/current/architecture/5-元件架構-component-architecture.md]
- Follow atomic design principles
- Components organized in atoms/, molecules/, organisms/ structure
- Admin components should be placed in `components/features/admin/` directory

### File Locations
[Source: docs/current/architecture/6-源碼樹整合-source-tree-integration.md]
```
apps/client/
├── src/
│   ├── app/
│   │   └── admin/                          (NEW - admin routes)
│   │       ├── _layout.tsx                 (NEW - admin layout with drawer)
│   │       ├── dashboard.tsx               (NEW - platform statistics)
│   │       ├── users.tsx                   (NEW - user management)
│   │       ├── events.tsx                  (NEW - event management)
│   │       └── system-health.tsx           (NEW - system monitoring)
│   ├── components/
│   │   └── features/
│   │       └── admin/                      (NEW - admin components)
│   │           ├── UserManagementTable.tsx (NEW)
│   │           ├── PlatformStatsCard.tsx   (NEW)
│   │           ├── SystemHealthIndicator.tsx (NEW)
│   │           └── ConfirmationDialog.tsx  (NEW)
│   ├── services/
│   │   └── adminService.ts                 (NEW - admin API service)
│   ├── hooks/
│   │   └── useAdminAuth.ts                 (NEW - admin auth hook)
│   └── localization/
│       └── locales/
│           └── zh-TW.json                   (MODIFY - add admin keys)
```

### UI/UX Requirements
[Source: docs/current/front-end-spec.md]
- **Navigation:** Side Drawer for admin (漢堡選單 on mobile, fixed sidebar on web)
- **Color Scheme:**
  - Primary: `#007BFF`
  - Success: `#28A745` (healthy status)
  - Warning: `#FFC107` (warning status)
  - Danger: `#DC3545` (critical status)
  - Light Grey: `#F8F9FA` (card backgrounds)
- **Typography:** System fonts (PingFang TC on iOS, Noto Sans CJK TC on Android)
- **Spacing:** 8pt grid system
- **Components:** React Native Elements with consistent theming

### Data Models and API Integration
[Source: packages/shared-types/src/index.ts]
- User interface needs to be extended with role field
- Suggested addition: `role: 'user' | 'organizer' | 'admin'`
- Will need to coordinate with backend team for role implementation
- Current User fields: id, name, email, phone, authProvider, createdAt, updatedAt

### Localization Keys Required
[Source: docs/current/front-end-spec.md - FR3 requirement]
```json
{
  "admin": {
    "title": "平台管理",
    "dashboard": "儀表板",
    "users": "使用者管理",
    "events": "活動管理",
    "systemHealth": "系統狀態",
    "reports": "報表",
    "statistics": {
      "totalUsers": "總使用者數",
      "activeEvents": "進行中活動",
      "totalRevenue": "總收入",
      "totalRegistrations": "總報名數",
      "timeRange": {
        "today": "今日",
        "week": "本週",
        "month": "本月",
        "year": "今年"
      }
    },
    "userManagement": {
      "searchPlaceholder": "搜尋使用者...",
      "status": {
        "active": "活躍",
        "suspended": "已停權",
        "deleted": "已刪除"
      },
      "actions": {
        "viewDetails": "查看詳情",
        "suspend": "停權",
        "activate": "啟用",
        "delete": "刪除"
      }
    },
    "systemStatus": {
      "api": "API 狀態",
      "database": "資料庫",
      "server": "伺服器",
      "lastChecked": "最後檢查時間",
      "refresh": "重新整理",
      "status": {
        "healthy": "正常",
        "warning": "警告",
        "critical": "嚴重"
      }
    },
    "confirmations": {
      "suspendUser": "確定要停權此使用者嗎？",
      "deleteUser": "確定要刪除此使用者嗎？此操作無法復原。",
      "unpublishEvent": "確定要下架此活動嗎？",
      "confirm": "確認",
      "cancel": "取消"
    }
  }
}
```

### Technical Stack
[Source: docs/current/architecture/3-技術棧對齊-tech-stack-alignment.md]
- **UI Components:** @rneui/base, @rneui/themed (React Native Elements)
- **Icons:** @expo/vector-icons (Material Community Icons)
- **Navigation:** React Navigation (Drawer Navigator for admin)
- **Localization:** i18next, react-i18next
- **Charts:** react-native-svg-charts (wrapped in RNE containers)
- **State Management:** React hooks (useState, useEffect, useCallback)

### Testing Standards
[Source: docs/current/architecture/7-系統整合遵循原則-system-integration-adherence.md]
- Test files use `.spec.tsx` naming convention
- Co-locate tests with components
- Use React Native Testing Library
- Mock external dependencies (services, navigation)
- Test both iOS and Android platforms
- Cover user interactions and accessibility
- Verify localization works correctly
- Mock admin API responses for testing

### Testing Requirements
- **Test Location:** Co-located with components (e.g., `users.spec.tsx`)
- **Framework:** Jest with React Native Testing Library
- **Setup Files:** 
  - `/apps/client/jest-setup.ts` for React Native tests
  - Mock `adminService` responses
  - Mock role-based auth checks
- **Coverage Requirements:**
  - Component rendering
  - Navigation between admin screens
  - User management actions
  - Statistics display and refresh
  - System health status updates
  - Confirmation dialog flows
  - Access control (redirect non-admins)

### Implementation Notes
1. **Role-Based Access:** Since User interface doesn't have role field yet, implementation should be prepared to handle this gracefully. Consider using a temporary mock or feature flag until backend support is ready.

2. **Admin Service:** Create comprehensive admin service with proper error handling, as this will be critical infrastructure for platform management.

3. **Real-time Updates:** System health monitoring should use polling (every 30 seconds) to keep status current without overwhelming the server.

4. **Performance:** Use React.memo and useCallback for admin tables with potentially large datasets.

5. **Security:** All admin actions should require confirmation dialogs to prevent accidental operations.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-11 | 1.0 | Initial story creation for Platform Admin Dashboard | Bob (Scrum Master) |
| 2025-01-11 | 1.1 | Completed all missing test implementations and added role field to User interface | James (Developer) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
N/A - No critical errors encountered

### Completion Notes List
- Implemented admin layout with drawer navigation using React Native Elements
- Created user management screen with search, filter, and pagination
- Built platform statistics dashboard with charts and time range selector
- Developed system health monitoring with real-time polling (30s interval)
- Built confirmation dialog component for destructive actions
- Created admin service layer with mock implementations
- Added role-based access control using temporary email-based check
- Created PlatformStatsCard component for statistics display
- Created SystemHealthIndicator component with progress bars and badges
- All Traditional Chinese localization keys added
- Implemented pull-to-refresh on all admin screens
- Note: Role field now added to User interface in shared-types
- Note: Charts using react-native-chart-kit for data visualization
- Completed all missing test implementations for Tasks 3, 4, 5, and 6
- Added testIDs to components for better test targeting
- Created comprehensive test suites with mocking and edge case coverage
- Added role field to User interface in shared-types package (user | organizer | admin)

### File List
- Created: `/apps/client/src/app/admin/_layout.tsx`
- Created: `/apps/client/src/app/admin/_layout.spec.tsx`
- Modified: `/apps/client/src/app/admin/dashboard.tsx` (full implementation + testIDs)
- Created: `/apps/client/src/app/admin/dashboard.spec.tsx`
- Created: `/apps/client/src/app/admin/users.tsx`
- Created: `/apps/client/src/app/admin/users.spec.tsx`
- Created: `/apps/client/src/app/admin/events.tsx`
- Modified: `/apps/client/src/app/admin/system-health.tsx` (full implementation)
- Created: `/apps/client/src/app/admin/system-health.spec.tsx`
- Created: `/apps/client/src/app/admin/reports.tsx`
- Created: `/apps/client/src/app/admin/audit.tsx`
- Created: `/apps/client/src/components/features/admin/UserManagementTable.tsx`
- Created: `/apps/client/src/components/features/admin/ConfirmationDialog.tsx`
- Created: `/apps/client/src/components/features/admin/ConfirmationDialog.spec.tsx`
- Modified: `/apps/client/src/components/features/admin/PlatformStatsCard.tsx` (added testIDs)
- Created: `/apps/client/src/components/features/admin/PlatformStatsCard.spec.tsx`
- Created: `/apps/client/src/components/features/admin/SystemHealthIndicator.tsx`
- Created: `/apps/client/src/components/features/admin/SystemHealthIndicator.spec.tsx`
- Created: `/apps/client/src/services/adminService.ts`
- Created: `/apps/client/src/services/adminService.spec.ts`
- Created: `/apps/client/src/hooks/useAdminAuth.ts`
- Modified: `/apps/client/src/localization/locales/zh-TW.json`
- Modified: `/packages/shared-types/src/index.ts` (added role field to User interface)

## QA Results