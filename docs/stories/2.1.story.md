# Story 2.1: Event Data Model & Database Migration

## Status
done

## Story
**As a** developer,
**I want** to define the `Event` data model and related database tables,
**so that** all necessary event information can be stored and managed.

## Acceptance Criteria
1. An `Event` model is defined with fields for title, description, dates, location, status, organizer ID, etc.
2. Models for `Category`, `Venue`, and `TicketType` are created and linked to the `Event` model.
3. A database migration script is created that successfully generates the corresponding tables and relationships.

## Tasks / Subtasks
- [x] Define Event, Category, Venue, TicketType TypeScript interfaces in shared-types package (AC: 1, 2)
  - [x] Create Event interface with id, organizerId, categoryId, venueId, title, description, startDate, endDate, location, status fields
  - [x] Create Category interface with id, name, description, color fields
  - [x] Create Venue interface with id, name, address, city, capacity, description fields
  - [x] Create TicketType interface with id, eventId, name, price, quantity fields
  - [x] Export all interfaces from packages/shared-types/src/index.ts
- [x] Create Event, Category, Venue, and TicketType entities for TypeORM in backend (AC: 1, 2)
  - [x] Create category.entity.ts file with TypeORM decorators
  - [x] Create venue.entity.ts file with TypeORM decorators
  - [x] Create event.entity.ts file with TypeORM decorators and foreign key references
  - [x] Create ticket-type.entity.ts file with TypeORM decorators
  - [x] Map TypeScript interface fields to database columns with proper relationships
  - [x] Include proper constraints and foreign key relationships
- [x] Create database migration scripts for all tables (AC: 3)
  - [x] Generate TypeORM migration file for categories table
  - [x] Generate TypeORM migration file for venues table
  - [x] Generate TypeORM migration file for events table with foreign key references
  - [x] Generate TypeORM migration file for ticket_types table
  - [x] Include proper indexes for performance (organizer_id, category_id, venue_id, event_id)
  - [x] Ensure foreign key constraints and cascade rules match schema
- [x] Test migration execution against development database (AC: 3)
  - [x] Run migration against development database
  - [x] Verify table structures match schema requirements
  - [x] Test migration rollback functionality
- [x] Add unit tests for all entities (Category, Venue, Event, TicketType)
  - [x] Test entity creation and validation for each model
  - [x] Test database constraints and relationships
  - [x] Test foreign key relationships between Event-Category, Event-Venue, Event-TicketType
  - [x] Test unique constraints (category names, etc.)

## Dev Notes

### Previous Story Insights
From Story 1.3 completion: User data model and database migration are established. PostgreSQL database connection is working with TypeORM configuration. UUID extension is already created. Database connection string format confirmed: `postgresql://user:password@localhost:5432/jctop_event`. NestJS backend (~10.3) has features-based module structure with TypeORM repository pattern established.

### Tech Stack Requirements
Backend Technologies [Source: architecture/tech-stack.md]:
- TypeScript ~5.5 (primary language for backend)
- NestJS ~10.3 (backend framework)  
- PostgreSQL 16 (primary relational database)
- Backend Testing: Jest & Supertest ~29.7 for unit and E2E API testing

### Data Models
Event Interface [Source: architecture/data-models.md]:
```typescript
interface Event {
  id: string;
  organizerId: string;
  categoryId: string;
  venueId: string;
  title: string;
  description: string;
  startDate: Date;
  endDate: Date;
  location: string;
  status: 'draft' | 'published' | 'ended' | 'paused';
  createdAt: Date;
  updatedAt: Date;
}
```

Category Interface [Source: architecture/data-models.md]:
```typescript
interface Category {
  id: string;
  name: string;
  description: string;
  color: string;
  createdAt: Date;
  updatedAt: Date;
}
```

Venue Interface [Source: architecture/data-models.md]:
```typescript
interface Venue {
  id: string;
  name: string;
  address: string;
  city: string;
  capacity: number;
  description: string;
  createdAt: Date;
  updatedAt: Date;
}
```

TicketType Interface [Source: architecture/data-models.md]:
```typescript
interface TicketType {
  id: string;
  eventId: string;
  name: string;
  price: number;
  quantity: number;
}
```

Event Relationships [Source: architecture/data-models.md]:
- An **Event** belongs to one **User** (the organizer)
- An **Event** belongs to one **Category**
- An **Event** belongs to one **Venue**
- An **Event** can have many **TicketTypes**
- An **Event** can have many **Registrations**

Category Relationships [Source: architecture/data-models.md]:
- A **Category** can have many **Events**

Venue Relationships [Source: architecture/data-models.md]:
- A **Venue** can have many **Events**

TicketType Relationships [Source: architecture/data-models.md]:
- A **TicketType** belongs to one **Event**

### Database Schema
Categories Table Definition [Source: architecture/database-schema.md]:
```sql
-- Categories for event classification
CREATE TABLE "categories" (
  "id" UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  "name" VARCHAR(255) NOT NULL UNIQUE,
  "description" TEXT,
  "color" VARCHAR(7) NOT NULL DEFAULT '#6366f1', -- Hex color code
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

Venues Table Definition [Source: architecture/database-schema.md]:
```sql
-- Venues where events take place
CREATE TABLE "venues" (
  "id" UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  "name" VARCHAR(255) NOT NULL,
  "address" TEXT,
  "city" VARCHAR(255),
  "capacity" INTEGER NOT NULL DEFAULT 0,
  "description" TEXT,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

Events Table Definition [Source: architecture/database-schema.md]:
```sql
-- Events created by organizers
CREATE TABLE "events" (
  "id" UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  "organizer_id" UUID NOT NULL REFERENCES "users"("id") ON DELETE CASCADE,
  "category_id" UUID NOT NULL REFERENCES "categories"("id") ON DELETE RESTRICT,
  "venue_id" UUID NOT NULL REFERENCES "venues"("id") ON DELETE RESTRICT,
  "title" VARCHAR(255) NOT NULL,
  "description" TEXT,
  "start_date" TIMESTAMPTZ NOT NULL,
  "end_date" TIMESTAMPTZ NOT NULL,
  "location" TEXT,
  "status" VARCHAR(50) NOT NULL DEFAULT 'draft', -- draft, published, ended, paused
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

Ticket Types Table Definition [Source: architecture/database-schema.md]:
```sql
-- Ticket types for each event
CREATE TABLE "ticket_types" (
  "id" UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  "event_id" UUID NOT NULL REFERENCES "events"("id") ON DELETE CASCADE,
  "name" VARCHAR(255) NOT NULL,
  "price" DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
  "quantity" INTEGER NOT NULL,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

Performance Indexes [Source: architecture/database-schema.md]:
```sql
-- Indexes for performance
CREATE INDEX ON "events" ("organizer_id");
CREATE INDEX ON "events" ("category_id");
CREATE INDEX ON "events" ("venue_id");
CREATE INDEX ON "events" ("status");
CREATE INDEX ON "events" ("start_date");
CREATE INDEX ON "categories" ("name");
CREATE INDEX ON "venues" ("city");
CREATE INDEX ON "ticket_types" ("event_id");
```

### File Locations
Based on Unified Project Structure [Source: architecture/unified-project-structure.md]:
```
packages/shared-types/src/
├── index.ts              <- Event, Category, Venue, and TicketType interface definitions and exports

apps/server/src/
├── entities/
│   ├── category.entity.ts    <- TypeORM Category entity
│   ├── venue.entity.ts       <- TypeORM Venue entity
│   ├── event.entity.ts       <- TypeORM Event entity with foreign key references
│   └── ticket-type.entity.ts <- TypeORM TicketType entity
└── migrations/
    ├── xxxx-CreateCategoriesTable.ts <- Categories table migration
    ├── xxxx-CreateVenuesTable.ts     <- Venues table migration
    ├── xxxx-CreateEventsTable.ts     <- Events table migration with foreign keys
    └── xxxx-CreateTicketTypesTable.ts <- Ticket types table migration
```

### Technical Constraints
Database Requirements:
- Must use UUID primary keys with uuid_generate_v4() default (UUID extension already created from Story 1.3)
- Categories must have unique name constraint to prevent duplicates
- Events must reference users(id) with foreign key and CASCADE delete
- Events must reference categories(id) with foreign key and RESTRICT delete (prevent deleting categories with events)
- Events must reference venues(id) with foreign key and RESTRICT delete (prevent deleting venues with events)
- TicketTypes must reference events(id) with foreign key and CASCADE delete
- Status field limited to: 'draft' | 'published' | 'ended' | 'paused'
- Color field must be hex color code format (7 characters starting with #)
- Timestamps with timezone (TIMESTAMPTZ) for all date fields
- Price field must be DECIMAL(10, 2) for currency precision
- Capacity field must be INTEGER with default 0
- Follow existing TypeORM configuration from previous stories

### Coding Standards
Critical Rules [Source: architecture/coding-standards.md]:
- **Type Sharing**: Define shared data structures in `packages/shared-types` and import them into both frontend and backend
- **Environment Variables**: Access environment variables only through a dedicated configuration module
- **Error Handling**: All API routes must use the standard error handling middleware

### Backend Architecture
Repository Pattern [Source: architecture/backend-architecture.md]:
```typescript
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Event } from './entities/event.entity';

@Injectable()
export class EventsService {
  constructor(
    @InjectRepository(Event)
    private eventsRepository: Repository<Event>,
  ) {}

  findOne(id: string): Promise<Event | null> {
    return this.eventsRepository.findOneBy({ id });
  }
}
```

### Testing
Unit Tests Required [Source: architecture/testing-strategy.md]:
- Category entity creation and field validation (unique name constraint)
- Venue entity creation and field validation (capacity validation)
- Event entity creation and field validation (foreign key relationships)
- TicketType entity creation and field validation
- Database constraints (foreign keys, not null fields, status enum, unique constraints)
- TypeORM repository integration for all entities
- Relationship testing between Event-Category, Event-Venue, Event-TicketType
- Migration script execution and rollback for all tables

Testing Strategy follows pyramid approach: Unit > Integration > E2E

Test File Locations:
- `apps/server/src/entities/category.entity.spec.ts` - Category entity unit tests
- `apps/server/src/entities/venue.entity.spec.ts` - Venue entity unit tests
- `apps/server/src/entities/event.entity.spec.ts` - Event entity unit tests
- `apps/server/src/entities/ticket-type.entity.spec.ts` - TicketType entity unit tests
- Test migration execution in development environment using Jest ~29.7

### Environment Configuration
Database Connection [Source: previous story 1.2]:
```bash
# Backend (apps/server/.env)
DATABASE_URL="postgresql://user:password@localhost:5432/jctop_event"
```

Migration execution uses existing database connection and TypeORM setup from previous stories.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-30 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-30 | 1.1 | Updated architecture docs and story to include Category and Venue models per AC 2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Migration execution: Successfully ran all 4 new table migrations (categories, venues, events, ticket_types)
- Migration rollback: Successfully tested rollback functionality for ticket_types table
- Database verification: Confirmed all table structures match schema requirements with proper foreign keys and indexes

### Completion Notes List
- All TypeScript interfaces created in shared-types package with proper typing
- All TypeORM entities created with correct decorators and relationships
- All database migrations created and successfully executed
- Foreign key relationships properly configured (CASCADE for user->event and event->ticket_type, RESTRICT for category->event and venue->event)
- Performance indexes created for all foreign key columns and frequently queried fields
- Unit tests created for all entities with comprehensive validation, relationship, and repository integration tests
- Linting and type checking pass successfully

### File List
- packages/shared-types/src/index.ts (updated with new interfaces)
- apps/server/src/entities/category.entity.ts (new)
- apps/server/src/entities/venue.entity.ts (new) 
- apps/server/src/entities/event.entity.ts (new)
- apps/server/src/entities/ticket-type.entity.ts (new)
- apps/server/src/migrations/1734000000000-CreateCategoriesTable.ts (new)
- apps/server/src/migrations/1735000000000-CreateVenuesTable.ts (new)
- apps/server/src/migrations/1736000000000-CreateEventsTable.ts (new)
- apps/server/src/migrations/1737000000000-CreateTicketTypesTable.ts (new)
- apps/server/src/entities/category.entity.spec.ts (new)
- apps/server/src/entities/venue.entity.spec.ts (new)
- apps/server/src/entities/event.entity.spec.ts (new)
- apps/server/src/entities/ticket-type.entity.spec.ts (new)
- apps/server/data-source.ts (new - TypeORM CLI configuration)
- apps/server/package.json (updated with migration scripts)
- apps/server/src/config/test-database.config.ts (updated with new entities)

## QA Results

### Review Date: 2025-07-30
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
**CRITICAL ISSUE: Frontend UI/UX Compliance Gap Identified**

The backend implementation is technically sound and meets all acceptance criteria for data modeling and database migration. However, there is a **critical gap** between this story's scope and the UI/UX guidelines specified in `docs/UIUX/`. The story focuses exclusively on backend data models while ignoring frontend presentation requirements that should accompany data model creation.

**Backend Assessment**: ✅ Excellent
- Clean, well-structured TypeORM entities
- Comprehensive interface definitions in shared-types
- Proper foreign key relationships and constraints
- High-quality, thorough test coverage
- Migration scripts follow best practices

### UI/UX Compliance Issues ❌

**Missing Frontend Components per UI/UX Guidelines:**
1. **EventCard Component** - Required by `component-library-design-system.md` for displaying event summaries
2. **Category Color Integration** - Categories have color field matching branding palette (`branding-style-guide.md`) but no frontend color display components
3. **Responsive Event Display** - No mobile/tablet/desktop breakpoint considerations per `responsiveness-strategy.md` 
4. **Accessibility Compliance** - No WCAG 2.1 Level AA components created per `accessibility-requirements.md`
5. **Performance Considerations** - No lazy loading or skeleton screens for event data per `performance-considerations.md`

### Refactoring Performed
**None Required** - Backend code quality is excellent and follows all architectural patterns correctly.

### Compliance Check
- Coding Standards: ✅ **Excellent adherence**
- Project Structure: ✅ **Files in correct locations**
- Testing Strategy: ✅ **Comprehensive test coverage with meaningful assertions**
- All Backend ACs Met: ✅ **Fully implemented**
- **UI/UX Guidelines**: ❌ **Not addressed - frontend components missing**

### Improvements Checklist

**Backend (All Complete):**
- [x] TypeScript interfaces properly defined and exported
- [x] TypeORM entities with correct decorators and relationships
- [x] Database migrations with proper foreign keys and indexes
- [x] Comprehensive unit tests covering all scenarios
- [x] Foreign key cascade rules properly configured

**Frontend (Missing - Required for Full Story Completion):**
- [ ] Create EventCard component using Chakra UI primitives per design system
- [ ] Implement category color display following branding guide hex codes (#2563EB primary, etc.)
- [ ] Add responsive breakpoints (320px mobile, 768px tablet, 1024px desktop, 1440px wide)
- [ ] Ensure WCAG 2.1 Level AA compliance (alt text, keyboard navigation, focus indicators)
- [ ] Implement performance optimization (3s load time goal, skeleton screens)
- [ ] Use Noto Sans TC / Inter fonts per typography guidelines
- [ ] Follow 4-pixel grid system for spacing

### Security Review
✅ **No security concerns** - Proper UUID usage, foreign key constraints prevent orphaned records, no sensitive data exposure in interfaces.

### Performance Considerations
✅ **Backend optimized** - Proper database indexes on all foreign keys and frequently queried fields (organizer_id, category_id, venue_id, status, start_date).
❌ **Frontend performance not addressed** - Missing lazy loading and skeleton screens per UI/UX guidelines.

### Final Status
❌ **Changes Required - Frontend UI/UX Components Missing**

**Recommendation**: While the backend implementation is excellent, this story should be extended to include the frontend components that will consume these data models, ensuring full compliance with the UI/UX guidelines in `docs/UIUX/`. The current implementation represents only 50% of what should be a complete feature including both data layer and presentation layer.