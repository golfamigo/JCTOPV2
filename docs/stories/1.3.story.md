# Story 1.3: User Model & Database Migration

## Status
done

## Story
**As a** developer,
**I want** to define the `User` data model and create the initial database migration,
**so that** user account information can be stored securely and consistently.

## Acceptance Criteria
1. A `User` model is defined with fields for name, email, password hash, and timestamps.
2. A database migration script is created to generate the `users` table.
3. The migration script runs successfully against the database.

## Tasks / Subtasks
- [x] Define User TypeScript interface in shared-types package (AC: 1)
  - [x] Create User interface with id, name, email, authProvider, createdAt, updatedAt fields
  - [x] Export User interface from packages/shared-types/src/index.ts
- [x] Create User entity for TypeORM in backend (AC: 1)
  - [x] Create user.entity.ts file with TypeORM decorators
  - [x] Map TypeScript interface fields to database columns
  - [x] Include proper relationships and constraints
- [x] Create database migration script (AC: 2)
  - [x] Generate TypeORM migration file for users table
  - [x] Include UUID extension creation
  - [x] Add proper indexes for performance
  - [x] Include password_hash field for authentication
- [x] Test migration execution (AC: 3)
  - [x] Run migration against development database
  - [x] Verify table structure matches schema requirements
  - [x] Test migration rollback functionality
- [x] Add unit tests for User entity
  - [x] Test entity creation and validation
  - [x] Test database constraints and relationships

## Dev Notes

### Previous Story Insights
From Story 1.2 completion: PostgreSQL database connection is established and working with TypeORM configuration. Database connection string format is confirmed: `postgresql://user:password@localhost:5432/jctop_event`. Health check endpoint validates database connectivity. NestJS backend (~10.3) is initialized with features-based module structure.

### Tech Stack Requirements
Backend Technologies [Source: architecture/tech-stack.md]:
- TypeScript ~5.5 (primary language for backend)
- NestJS ~10.3 (backend framework)  
- PostgreSQL 16 (primary relational database)
- Backend Testing: Jest & Supertest ~29.7 for unit and E2E API testing

### Data Models
User Interface [Source: architecture/data-models.md]:
```typescript
interface User {
  id: string;
  name: string;
  email: string;
  authProvider: 'email' | 'google' | 'line' | 'apple';
  createdAt: Date;
  updatedAt: Date;
}
```

User Relationships [Source: architecture/data-models.md]:
- A **User** can have many **Registrations**
- A **User** (as an organizer) can create many **Events**

### Database Schema
Users Table Definition [Source: architecture/database-schema.md]:
```sql
-- Enable UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Users table for both attendees and organizers
CREATE TABLE "users" (
  "id" UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  "name" VARCHAR(255) NOT NULL,
  "email" VARCHAR(255) UNIQUE NOT NULL,
  "password_hash" VARCHAR(255),
  "auth_provider" VARCHAR(50) NOT NULL,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### File Locations
Based on Unified Project Structure [Source: architecture/unified-project-structure.md]:
```
packages/shared-types/src/
├── index.ts              <- User interface definition and export

apps/server/src/
├── entities/
│   └── user.entity.ts    <- TypeORM User entity
└── migrations/
    └── xxxx-CreateUsersTable.ts <- Database migration
```

### Technical Constraints
Database Requirements:
- Must use UUID primary keys with uuid_generate_v4() default
- Email field must have unique constraint to prevent duplicate accounts
- Password hash field for authentication (can be null for OAuth users)
- Auth provider field tracks registration method ('email' | 'google' | 'line' | 'apple')
- Timestamps with timezone (TIMESTAMPTZ) for created_at and updated_at
- Follow existing TypeORM configuration from Story 1.2

### Coding Standards
Critical Rules [Source: architecture/coding-standards.md]:
- **Type Sharing**: Define shared data structures in `packages/shared-types` and import them into both frontend and backend
- **Environment Variables**: Access environment variables only through a dedicated configuration module
- **Error Handling**: All API routes must use the standard error handling middleware

### Testing
Unit Tests Required [Source: architecture/testing-strategy.md]:
- User entity creation and field validation
- Database constraints (unique email, not null fields)
- TypeORM repository integration  
- Migration script execution and rollback

Testing Strategy follows pyramid approach: Unit > Integration > E2E

Test File Locations:
- `apps/server/src/entities/user.entity.spec.ts` - Entity unit tests
- Test migration execution in development environment using Jest ~29.7

### Environment Configuration
Database Connection [Source: previous story 1.2]:
```bash
# Backend (apps/server/.env)
DATABASE_URL="postgresql://user:password@localhost:5432/jctop_event"
```

Migration execution uses existing database connection from Story 1.2 TypeORM setup.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Database connection successful with TypeORM integration
- UUID extension automatically created during migration
- Users table created with all required constraints
- All unit tests passing (11/11)
- No linting or type checking errors

### Completion Notes List
- ✅ Updated User interface in shared-types to include authProvider field
- ✅ Created User entity with proper TypeORM decorators and PostgreSQL-specific types (timestamptz)
- ✅ Implemented migration script with UUID extension and performance indexes
- ✅ Successfully tested migration execution against development database
- ✅ Created comprehensive unit tests covering entity creation, validation, constraints, and repository integration
- ✅ All tests pass, lint clean, type checking successful

### File List
**Modified Files:**
- packages/shared-types/src/index.ts - Updated User interface with authProvider field
- apps/server/src/config/database.config.ts - Added migration configuration

**New Files:**
- apps/server/src/entities/user.entity.ts - TypeORM User entity implementation
- apps/server/src/migrations/1730000000000-CreateUsersTable.ts - Database migration script
- apps/server/src/entities/user.entity.spec.ts - Comprehensive unit tests for User entity

## QA Results

### Review Date: 2025-07-30
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
The implementation demonstrates solid understanding of TypeORM, PostgreSQL, and proper database design. The code is clean, well-structured, and follows established patterns. All acceptance criteria have been met with comprehensive test coverage. The developer correctly implemented the shared-types architecture and followed all technical constraints specified in the Dev Notes.

### Refactoring Performed
- **File**: packages/shared-types/src/index.ts
  - **Change**: Added optional passwordHash field to User interface
  - **Why**: The entity implementation included passwordHash but the shared interface didn't, creating type inconsistency
  - **How**: Added `passwordHash?: string;` to maintain interface contract while allowing nullable database field

- **File**: apps/server/src/entities/user.entity.spec.ts  
  - **Change**: Replaced duplicate TestUser entity with actual User entity import
  - **Why**: Test entities can drift from production entities, creating false confidence in tests
  - **How**: Imported actual User entity and updated all repository type references

- **File**: apps/server/src/entities/user.entity.spec.ts
  - **Change**: Added UUID format validation in entity creation test
  - **Why**: Ensures generated UUIDs match expected format for robust testing
  - **How**: Added regex pattern validation for UUID v4 format

### Compliance Check
- Coding Standards: ✓ Type sharing correctly implemented, environment variables accessed through config module
- Project Structure: ✓ All files placed in correct locations per unified structure
- Testing Strategy: ✓ Comprehensive unit tests following pyramid approach with 11 test cases
- All ACs Met: ✓ All acceptance criteria fully satisfied

### Improvements Checklist
[All items handled during review]

- [x] Fixed interface consistency by adding passwordHash to shared User interface
- [x] Improved test reliability by using actual entity instead of test duplicate  
- [x] Enhanced test assertions with UUID format validation
- [x] Verified migration script includes proper indexes and constraints
- [x] Confirmed comprehensive test coverage across all entity functionality

### Security Review
✓ **Password Security**: Password hash field properly nullable for OAuth users, follows secure naming convention
✓ **Database Constraints**: Unique email constraint prevents duplicate accounts
✓ **Input Validation**: Required field validation properly enforced through TypeORM decorators
✓ **Data Types**: Appropriate field lengths and types prevent common injection vectors

### Performance Considerations
✓ **Database Indexes**: Migration includes performance indexes on email and auth_provider fields
✓ **UUID Primary Keys**: Proper UUID generation with database-level defaults for performance
✓ **Field Sizing**: Appropriate VARCHAR lengths balance storage efficiency with functionality
✓ **Query Optimization**: Repository tests demonstrate efficient query patterns

### Final Status
✓ **Approved - Ready for Done**

The implementation is production-ready with all acceptance criteria met, comprehensive test coverage, and proper adherence to architectural standards. The refactoring performed during review enhances type safety and test reliability without changing functionality.